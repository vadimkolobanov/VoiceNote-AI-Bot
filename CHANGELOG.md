# Журнал изменений

Все заметные изменения в этом проекте будут задокументированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Семантического Версионирования](https://semver.org/lang/ru/spec/v2.0.0.html) (или будет, как только достигнет более стабильного состояния).
Отлично! Ведение `CHANGELOG.md` — признак профессионального подхода. Это очень помогает и пользователям, и вам самим отслеживать развитие проекта.

Вот как можно оформить версии 0.6.1 и 0.6.2, основываясь на ваших последних изменениях. Я постарался сделать их лаконичными, но информативными, в стиле "Keep a Changelog".

---

### Обновленный `CHANGELOG.md`

# Журнал изменений

Все заметные изменения в этом проекте будут задокументированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Семантического Версионирования](https://semver.org/lang/ru/spec/v2.0.0.html) (или будет, как только достигнет более стабильного состояния).

## [0.6.1-2] - 2025-06-20

### Добавлено

*   **Инструменты администрирования:**
    *   Для администратора добавлена команда `/broadcast` для массовой рассылки сообщений всем пользователям бота. Рассылка выполняется в фоновом режиме с контролем скорости для избежания блокировок со стороны Telegram.
*   **Улучшения UX:**
    *   Введен лимит на максимальную длительность голосового сообщения (30 секунд) для ускорения обработки и предотвращения злоупотреблений. Пользователь получает вежливое уведомление, если его сообщение слишком длинное.
*   **Мониторинг и логирование:**
    *   Добавлена интеграция с сервисом `Logtail` для централизованного сбора и анализа логов в реальном времени.
    *   Полностью переработана система логирования в `main.py` для более чистого вывода, ротации файлов и уменьшения "шума" от сторонних библиотек.

### Исправлено

*   **База данных:** Устранена критическая ошибка `AttributeError: module 'database_setup' has no attribute 'set_user_timezone'`, возникавшая при попытке сменить часовой пояс. Добавлены недостающие функции для работы с настройками пользователя (`set_user_timezone`, `set_user_default_reminder_time`, `set_user_pre_reminder_minutes`).


## [0.6.0] - 2025-06-16

### Добавлено

*   **Напоминания о днях рождения:**
    *   Реализован новый раздел для хранения важных дат (дней рождения, годовщин).
    *   Бот автоматически создает ежегодные напоминания для сохраненных дат.
    *   Для **VIP-пользователей** добавлена возможность массового импорта дат из текстового файла.
*   **Экспорт данных (⭐ VIP-функция):**
    *   VIP-пользователи теперь могут экспортировать свои заметки.
    *   Добавлен выбор формата экспорта (**JSON, CSV, TXT**) и набора данных для выгрузки (активные, архивные, все).
*   **Система донатов:**
    *   В информационный раздел добавлена возможность поддержать проект через донат (ЮMoney).
    *   Реализована страница с инструкцией и динамической подстановкой Telegram ID пользователя для удобства.
*   **Улучшенный онбординг:**
    *   В стартовое сообщение (`/start`) добавлен блок, информирующий новых пользователей о необходимости установить свой часовой пояс.
    *   Для пользователей с часовым поясом по умолчанию (UTC) в главном меню появляется дополнительная кнопка для быстрой настройки.
*   **Информационный раздел:**
    *   Создан раздел "ℹ️ Инфо & Помощь" с подробной инструкцией по использованию, описанием VIP-функций и ссылками на ресурсы проекта.

### Изменено

*   **Позиционирование VIP-функций:**
    *   Полностью переработаны тексты в настройках и на лендинг-странице. Теперь акцент делается на том, что базовые функции доступны всем, а VIP — это расширение возможностей, а не платный доступ.
*   **Логика определения времени:**
    *   Внутренняя логика бота (не LLM) теперь выполняет "санитарную проверку" даты. Если LLM вернул время, которое уже прошло сегодня (например, "8 утра" для вечернего сообщения), бот автоматически переносит напоминание на следующий день.
*   **Промпт для LLM:**
    *   Системный промпт для DeepSeek был доработан для более точного извлечения даты с учетом часового пояса пользователя, но основная логика переноса даты вынесена в код бота для надежности.
*   **Уведомления о смене статуса:**
    *   Сообщение о выдаче VIP теперь перечисляет все доступные премиум-функции.
    *   При отзыве VIP-статуса у пользователя, его персональные настройки напоминаний автоматически сбрасываются к значениям по умолчанию.
*   **Пользовательский интерфейс (UX):**
    *   Устранены "тупики" в диалоге. После выполнения действий (сохранение заметки, отметка о выполнении) бот теперь всегда предлагает дальнейшие шаги, возвращая пользователя в меню или к списку заметок.

### Исправлено

*   **Некорректное отображение времени:** Исправлен баг, из-за которого в сообщении с предложением сохранить заметку дата отображалась в UTC, а не в часовом поясе пользователя.
*   **Ошибка при динамическом добавлении кнопок:** Устранена ошибка `AttributeError: 'InlineKeyboardMarkup' object has no attribute 'builder'`, возникавшая при попытке добавить кнопку настройки часового пояса в `/start`.


## [0.5.0] - 2025-06-15

### Добавлено


*   **Система статусов (Free & VIP):**
    *   Внедрена логика разделения пользователей на Free и VIP.
    *   Для Free-пользователей ограничены продвинутые функции напоминаний.
*   **Интерактивные уведомления о напоминаниях:**
    *   В уведомления добавлены инлайн-кнопки: "✅ Выполнено", "Отложить на 1 час", "Отложить на 3 часа".
    *   Реализованы хендлеры для выполнения, архивации и переноса (`snooze`) напоминаний прямо из уведомления.
*   **Расширенные настройки пользователя:**
    *   Пользователи теперь могут настраивать **время напоминаний по умолчанию** (для задач, где указана только дата).
    *   Добавлена настройка **предварительных напоминаний** (за 30 мин, 1 час, 24 часа до срока).
    *   Все настройки вынесены в единый раздел "⚙️ Настройки" в профиле пользователя.
*   **Система заявок на VIP-статус:**
    *   Для пользователей без VIP-статуса при попытке доступа к платным функциям отображается информационное сообщение.
    *   Добавлена кнопка "🚀 Отправить заявку на VIP", которая уведомляет администратора о желании пользователя получить доступ.
*   **Информационный раздел:**
    *   В главное меню добавлена кнопка "ℹ️ Инфо & Помощь".
    *   Создан новый раздел с подробной инструкцией "Как пользоваться", описанием VIP-возможностей и ссылками на новостной канал и чат проекта.
*   **Инструменты для отладки:**
    *   Для администратора добавлена команда `/jobs` для просмотра всех активных задач в планировщике `APScheduler`.

### Изменено

*   **Логика планировщика напоминаний:**
    *   Планировщик теперь учитывает VIP-статус пользователя: "умные" и предварительные напоминания создаются только для VIP.
    *   Исправлен баг, из-за которого время напоминания, установленное по умолчанию, не сохранялось в базе данных и некорректно отображалось в интерфейсе.
    *   Улучшена система создания и удаления задач в `APScheduler` для корректной обработки нескольких напоминаний (основного и предварительного) на одну заметку.
*   **Пользовательский интерфейс (UX):**
    *   После выполнения действий (сохранение/отмена заметки, выполнение задачи) пользователь теперь не остается в "тупике", а получает сообщение с главным меню или перенаправляется в обновленный список заметок.
    *   Убраны системные термины (например, `create_reminder`) из ответа LLM, который видит пользователь.
    *   Обновлены тексты уведомлений о выдаче/снятии VIP-статуса с перечислением всех актуальных функций.
*   **Структура проекта:**
    *   Логика настройки часовых поясов перенесена в новый, единый роутер `handlers/settings.py`.
    *   Добавлен новый роутер `handlers/info.py` для информационного раздела.

### Исправлено

*   **Ошибка CallbackData:** Устранена ошибка `ValueError: Separator symbol ':' can not be used`, возникавшая из-за передачи времени в `callback_data`.
*   **Ошибка `message can't be edited`:** Исправлена ошибка, возникавшая при попытке редактировать сообщение пользователя после ручного ввода данных в FSM.
*   Исправлен баг, из-за которого предварительные напоминания не создавались из-за неполной передачи данных в планировщик.

### Безопасность

*   При отзыве VIP-статуса у пользователя теперь автоматически сбрасываются все персональные настройки, связанные с платными функциями.


## [0.4.0] - 2025-06-14

### Добавлено

*   **Система напоминаний:**
    *   Реализована базовая система напоминаний. Если при создании заметки LLM распознает дату и время (`due_date`), бот автоматически запланирует напоминание.
    *   Интегрирован планировщик `APScheduler` для обработки отложенных задач.
    *   При старте бота все предстоящие напоминания загружаются из базы данных.
    *   Напоминания корректно отменяются при удалении или архивации заметки и восстанавливаются при извлечении из архива.
    *   Для задач, где указана только дата (без времени), напоминание по умолчанию устанавливается на 9:00 UTC.
    *   В уведомление о напоминании добавлена инлайн-кнопка для быстрого перехода к просмотру заметки.
*   **VIP-статус и Админ-панель:**
    *   Введена система **VIP-статуса**, который снимает все лимиты (на количество заметок и распознаваний).
    *   Создана **панель администратора**, доступная по ID из `.env`.
    *   Добавлена команда `/users` для админа, отображающая список всех пользователей с пагинацией.
    *   Добавлена команда `/admin <ID>` (или ответом на сообщение), которая показывает детальную информацию о пользователе и инлайн-кнопку для выдачи/отзыва VIP-статуса.
    *   Администратор получает уведомление об успешной смене статуса, а пользователь — информационное сообщение о получении или снятии VIP.
*   **Управление заметками:**
    *   Добавлена возможность **прослушать оригинальное аудио** для заметки, если оно было сохранено.
    *   Реализована система **категорий**. Пользователь может изменить категорию заметки, выбрав из предопределенного списка (`Общее`, `Работа`, `Личное` и т.д.).
*   **Новые зависимости:**
    *   Добавлена библиотека `apscheduler` для работы с отложенными задачами.

### Изменено

*   **Улучшено извлечение дат LLM:**
    *   Системный промпт для LLM был доработан для более точного извлечения дат и времени. Теперь в LLM передается точное время в UTC для корректного расчета относительных временных промежутков ("через 5 минут").
*   **Интерфейс и UX:**
    *   В профиле пользователя теперь отображается его VIP-статус и лимиты (или их отсутствие).
    *   В окне просмотра заметки отображается ее категория и добавлены новые кнопки действий ("Прослушать аудио", "Изменить категорию").
*   **База данных:**
    *   В таблицу `users` добавлено поле `is_vip (BOOLEAN)`.
    *   В таблицу `notes` добавлено поле `category (TEXT)`.
    *   Добавлена функция `get_all_users_paginated` для получения списка пользователей для админ-панели.

### Исправлено

*   **Полный цикл управления заметками:**
    *   Исправлено удаление заметки через FSM.



## [0.3.0] - 2025-06-12

### Добавлено

*   **Полный цикл управления заметками:**
    *   Реализована возможность **редактировать текст** существующих заметок через FSM.
    *   Добавлена функция **архивации** заметок, позволяющая убирать их из основного списка.
    *   Добавлена функция **восстановления** заметок из архива.
    *   Создан отдельный раздел для просмотра **архивированных заметок** с пагинацией.
    *   Внедрено **двухэтапное удаление** заметки (через подтверждение) для предотвращения случайных удалений.
*   **Поддержка часовых поясов:**
    *   Пользователи теперь могут **устанавливать свой часовой пояс** в настройках профиля.
    *   Добавлено меню с выбором из распространенных часовых поясов и возможностью ручного ввода.
    *   Все даты и время в интерфейсе бота (профиль, просмотр заметок) теперь отображаются с учетом **локального времени пользователя**.
*   **Новые зависимости:**
    *   Добавлена библиотека `pytz` для работы с часовыми поясами.

### Изменено

*   **Улучшен интерфейс:**
    *   Полностью переработан экран **профиля пользователя**: улучшена структура, добавлена информация о лимитах и текущем часовом поясе.
    *   **Клавиатуры действий с заметкой** стали контекстно-зависимыми: отображают разные кнопки для активных и архивированных заметок.
    *   В главное меню добавлена кнопка **"🗄️ Архив"**.
*   **База данных:**
    *   В таблицу `users` добавлено поле `timezone` (TEXT) для хранения часового пояса пользователя.
*   **Структура проекта:**
    *   Добавлен новый модуль `services/tz_utils.py` для утилит по работе с часовыми поясами.
    *   Добавлен новый роутер `handlers/timezone_selector.py` для обработки логики выбора часового пояса.
    *   В FSM (`states.py`) добавлены новые состояния для редактирования заметок и настройки профиля.

### Исправлено

*   Устранена **ошибка циклического импорта** (`circular import`) путем отказа от импорта экземпляра `bot` в хендлеры и использования `message.bot` / `callback_query.bot`.



## [0.2.0]- 2025-05-26

### Добавлено

* Команда help с описанием функционала бота
* Добавлена пагинация для списка заметок
* Добавлена возможность удалить заметку
* Добавлена возможность просмотреть заметку подробно
* Добавлен лимит на количество распознаваний в день

### Изменено
* Изменена STT модель на Yandex SpeechKit
* Изменена структура файлов проекта
* Изменена структура базы данных
* Изменена логика распознавания пустых сообщений

### Устарело


### Удалено


### Исправлено
* Исправлен баг с распознаванием пустых сообщений

### Безопасность


## [0.1.0] - 2025-05-21 (MVP+)

Это первоначальный MVP+ (Минимально жизнеспособный продукт Плюс) релиз Telegram-бота "VoiceNote AI".

### Добавлено

*   **Основная обработка голосовых заметок:**
    *   Пользователи могут отправлять боту голосовые сообщения.
    *   Транскрибация речи в текст (STT) с использованием внешнего API Hugging Face Space.
    *   Улучшение текста и извлечение информации с помощью DeepSeek LLM API:
        *   Исправление ошибок транскрибации STT, грамматики и пунктуации.
        *   Извлечение описаний задач/событий, дат/времени, упомянутых людей, мест и предполагаемых намерений.
*   **Управление заметками:**
    *   Пользователи могут сохранять обработанные голосовые заметки в базу данных PostgreSQL.
        *   Данные заметки включают: оригинальный текст STT, исправленный текст LLM, полный JSON-ответ от LLM с анализом, `file_id` аудиофайла Telegram и извлеченную дату выполнения (`due_date`).
        *   Дата/время оригинального голосового сообщения (`message.date`) сохраняется как `note_taken_at`.
    *   Пользователи могут просматривать свои последние 5 заметок через inline-кнопку "📝 Мои заметки". Каждая заметка отображается отдельно с возможностью удаления.
    *   Пользователи могут удалять отдельные заметки.
    *   Реализован MVP-лимит в 5 активных заметок на пользователя.
*   **Профиль пользователя:**
    *   Пользователи могут просматривать базовый профиль через inline-кнопку "👤 Профиль".
    *   Профиль отображает Telegram ID, имя пользователя (username), имя, дату регистрации, заглушку для статуса подписки ("Бесплатная (MVP)") и текущее количество заметок относительно MVP-лимита.
*   **Регистрация пользователя:**
    *   Автоматическая регистрация/обновление пользователя в базе данных при первом взаимодействии (`/start` или первое сообщение).
*   **База данных:**
    *   Бэкенд на PostgreSQL с использованием драйвера `asyncpg`.
    *   Схема включает таблицы: `users`, `notes`, а также заготовки для `subscriptions`, `payments`, `user_subscriptions`.
    *   Автоматическое создание таблиц при запуске бота, если они не существуют.
    *   Тип подписки по умолчанию "Full Месячная" добавлен в таблицу `subscriptions` для будущего использования.
*   **Взаимодействие с ботом:**
    *   Inline-клавиатуры для основных действий ("📝 Мои заметки", "👤 Профиль") и действий с конкретными заметками ("🗑️ Удалить").
    *   Реализована FSM (Конечный автомат) для двухэтапного процесса сохранения заметки (подтверждение).
    *   Пользователь возвращается в главное меню после создания или удаления заметки.
*   **Конфигурация и развертывание:**
    *   Конфигурация через переменные окружения (токен Telegram, API-ключ DeepSeek, параметры подключения к БД).
    *   Использование `python-dotenv` для загрузки переменных окружения при локальной разработке.
    *   Предоставлен `Dockerfile` для сборки Docker-образа для развертывания.
    *   `requirements.txt` для зависимостей Python.
*   **Структура проекта и документация:**
    *   Модульная структура кода (`main.py`, `database_setup.py`, `llm_processor.py`, `utills.py`, `inline_keyboards.py`).
    *   Базовые строки документации (docstrings) в Python-файлах.
    *   Начальные версии `README.md` и этого `CHANGELOG.md`.

### Изменено

*   

### Исправлено

*   Начальные проблемы с `asyncpg` и типами данных JSON/JSONB решены путем обеспечения сериализации Python dict в строки JSON перед вставкой/обновлением в базе данных.